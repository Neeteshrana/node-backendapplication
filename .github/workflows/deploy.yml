name: Deploy Node Backend using Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Stop and remove existing Docker container
        run: |
          echo "ðŸ›‘ Stopping existing container..."
          sudo docker stop node-backend || true
          sudo docker rm node-backend || true

      - name: Remove existing Docker image
        run: |
          echo "ðŸ§¹ Removing old image..."
          sudo docker rmi node-backend-image || true

      - name: Build Docker image
        run: |
          echo "ðŸ”¨ Building Docker image..."
          sudo docker build -t node-backend-image .

      - name: Run Docker container
        run: |
          echo "ðŸš€ Starting Docker container..."
          sudo docker run -d --name node-backend -p 3000:3000 node-backend-image

      - name: Deployment Success ðŸŽ‰
        if: success()
        run: |
          echo "âœ… DEPLOYMENT SUCCESSFUL âœ…"
          echo "--------------------------------------------"
          echo "ðŸŒ App URL: http://noded.bitedge.app"
          echo "ðŸ•’ Time: $(date)"
          echo "ðŸ“¡ Host: $(hostname)"
          echo "--------------------------------------------"

      - name: Logs on Failure
        if: failure()
        run: |
          echo "âŒ DEPLOYMENT FAILED âŒ"
          sudo docker logs node-backend || true | tail -n 20 > failure.log
          if [ ! -s failure.log ]; then echo "No failure logs found." > failure.log; fi
