name: Deploy Node Backend using Docker

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Stop and remove existing Docker container
        run: |
          echo "ğŸ›‘ Stopping existing container..."
          docker stop node-backend || true
          docker rm node-backend || true

      - name: Remove existing Docker image
        run: |
          echo "ğŸ§¹ Removing old image..."
          docker rmi node-backend-image || true

      - name: Build Docker image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          docker build -t node-backend-image .

      - name: Run Docker container
        run: |
          echo "ğŸš€ Starting Docker container..."
          docker run -d --name node-backend -p 3000:3000 node-backend-image

      - name: Deployment Success ğŸ‰
        if: success()
        run: |
          echo "âœ… DEPLOYMENT SUCCESSFUL âœ…"
          echo "--------------------------------------------"
          echo "ğŸŒ App URL: http://<your-server-ip>:3000"
          echo "ğŸ•’ Time: $(date)"
          echo "ğŸ“¡ Host: $(hostname)"
          echo "--------------------------------------------"

      - name: Logs on Failure
        if: failure()
        run: |
          echo "âŒ DEPLOYMENT FAILED âŒ"
          docker logs node-backend || true | tail -n 20 > failure.log
          if [ ! -s failure.log ]; then echo "No failure logs found." > failure.log; fi
